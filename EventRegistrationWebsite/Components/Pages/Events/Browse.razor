@page "/events/browse"
@rendermode InteractiveServer

@using System
@using System.Linq
@using System.Collections.Generic
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@using EventRegistrationWebsite.Data
@using EventRegistrationWebsite.Models

@inject ApplicationDbContext Db
@inject NavigationManager Nav
@inject IJSRuntime JS

<style>
    .mg-cardBtn {
        height: 96px;
        font-weight: 600;
        position: relative;
        overflow: hidden;
    }

        .mg-cardBtn:active {
            transform: scale(0.98);
        }

    .mg-reveal {
        animation: mgPop 260ms ease-out;
    }

    @@keyframes mgPop {
        0% {
            transform: scale(0.98);
            opacity: 0.85;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .mg-wallet {
        max-height: 140px;
        overflow-y: auto;
    }

    .mg-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,0.12);
        background: #f8f9fa;
        font-size: 0.85rem;
    }
</style>

<CascadingAuthenticationState>
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="mb-0">Events</h2>

        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary" @onclick="OpenGame">
                🎁 Play for voucher
            </button>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-2">
                <div class="col-12 col-md-6">
                    <input class="form-control"
                           placeholder="Search by title or description"
                           @bind="searchText"
                           @bind:event="oninput" />
                </div>

                <div class="col-12 col-md-3">
                    <select class="form-select" @bind="modeFilter">
                        <option value="">All</option>
                        <option value="Online">Online</option>
                        <option value="Physical">Physical</option>
                    </select>
                </div>

                <div class="col-12 col-md-3 d-grid">
                    <button class="btn btn-outline-secondary" @onclick="ClearFilters">
                        Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <p>Loading events...</p>
    }
    else if (!FilteredEvents.Any())
    {
        <div class="alert alert-info">No events found.</div>
    }
    else
    {
        <div class="row g-3">
            @foreach (var ev in FilteredEvents)
            {
                <div class="col-12">
                    <div class="card">
                        <div class="row g-0">
                            <div class="col-12 col-md-4">
                                <img src="@(string.IsNullOrWhiteSpace(ev.BannerImagePath) ? "/images/placeholder-eventPic.png" : ev.BannerImagePath)"
                                     class="img-fluid rounded-start"
                                     style="height: 200px; width: 100%; object-fit: cover;"
                                     alt="Event banner" />
                            </div>

                            <div class="col-12 col-md-8">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start gap-3">
                                        <div class="flex-grow-1">
                                            <h5 class="card-title mb-1">@ev.Title</h5>
                                            <div class="text-muted">
                                                @ev.StartDate.ToString("dd MMM yyyy") to @ev.EndDate.ToString("dd MMM yyyy")
                                            </div>

                                            <div class="mt-2 d-flex flex-wrap gap-2">
                                                <span class="badge bg-secondary">@ev.ComputedStatus</span>

                                                @if (ev.IsOnline)
                                                {
                                                    <span class="badge bg-info">Online</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-dark">Physical</span>
                                                }

                                                @* Availability chip driven by the SAME effective fill logic *@
                                                @if (ev.TicketingEnabled && !ev.IsCancelled && ev.Capacity > 0)
                                                {
                                                    var pct = EffectiveFillPercent(ev);
                                                    var (label, cls) = AvailabilityBadge(pct);
                                                    <span class="badge @cls">@label</span>
                                                }

                                                <span class="badge bg-primary">
                                                    <span style="font-size:1.05rem">@PopularityFace(ev)</span>
                                                    <span class="ms-1">@PopularityLabel(ev)</span>
                                                </span>

                                                @if (ev.TicketingEnabled && !ev.IsCancelled)
                                                {
                                                    <span class="badge bg-success">@TicketPriceText(ev)</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-dark">Ticketing off</span>
                                                }
                                            </div>

                                            @if (!string.IsNullOrWhiteSpace(ev.Summary))
                                            {
                                                <div class="mt-2">@ev.Summary</div>
                                            }
                                            else if (!string.IsNullOrWhiteSpace(ev.Description))
                                            {
                                                <div class="mt-2">@Shorten(ev.Description, 120)</div>
                                            }
                                        </div>

                                        <div class="text-end" style="min-width: 160px;">
                                            <div class="text-muted small">Last updated</div>
                                            <div>@ev.LastUpdatedOn.ToString("dd/MM/yyyy HH:mm")</div>

                                            <div class="d-grid gap-2 mt-3">
                                                <button class="btn btn-outline-primary" @onclick="() => GoDetails(ev.EventID)">
                                                    View
                                                </button>

                                                <button class="btn btn-primary" disabled>
                                                    Register (mock)
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    @* ===================== MINI GAME POPUP ===================== *@
    @if (showGameModal)
    {
        @* Backdrop NEVER closes the modal *@
        <div style="position:fixed; inset:0; background: rgba(0,0,0,0.55); z-index:5000;"></div>

        <div class="card shadow"
             style="position:fixed; z-index:6000; top:10%; left:50%; transform: translateX(-50%); width:min(600px, 92vw);"
             @onclick:stopPropagation="true">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="mb-1">🎮 Mini Game: Pick a card</h5>
                        <div class="text-muted small">
                            Plays left today: <span class="fw-semibold">@playsLeft</span>
                            <span class="ms-2 mg-pill" title="Current win chance">
                                🍀 Win chance: @($"{Math.Round(CurrentWinChance() * 100)}%")
                            </span>
                        </div>
                    </div>

                    @* Only this button can close *@
                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="CloseGame">
                        ✕ Close
                    </button>
                </div>

                <AuthorizeView Roles="Admin">
                    <div class="mt-3 border rounded p-3 bg-light">
                        <div class="fw-semibold mb-2">Admin controls (this browser)</div>

                        <div class="row g-2">
                            <div class="col-12 col-md-6">
                                <label class="form-label">Win chance boost</label>
                                <input type="range" min="0" max="40" step="5"
                                       class="form-range"
                                       @bind="adminWinBoostPct" />
                                <div class="text-muted small">
                                    Boost: @adminWinBoostPct% (makes it easier)
                                </div>
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Guaranteed win on 2nd try</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="g2"
                                           @bind="adminGuaranteeSecondWin" />
                                    <label class="form-check-label" for="g2">
                                        If 1st try loses, 2nd try wins
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-2">
                            <button type="button" class="btn btn-outline-danger" @onclick="ResetDailyGameToTwoPlays">
                                Reset daily mini game back to 2 plays
                            </button>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(adminMsg))
                        {
                            <div class="small text-success mt-2">@adminMsg</div>
                        }
                    </div>
                </AuthorizeView>

                @if (voucherWallet.Any())
                {
                    <div class="mt-3">
                        <div class="fw-semibold mb-1">Voucher wallet (this browser)</div>
                        <div class="mg-wallet border rounded p-2 bg-white">
                            @foreach (var v in voucherWallet.Take(10))
                            {
                                <div class="d-flex justify-content-between align-items-center py-1">
                                    <div class="fw-semibold">@v.Code</div>
                                    <div class="text-muted small">@v.Percent% off</div>
                                </div>
                            }
                        </div>

                        <div class="text-muted small mt-1">
                            Stored in localStorage for demo.
                        </div>
                    </div>
                }

                <hr />

                @* IMPORTANT: even when playsLeft is 0, we DO NOT close. We show state until user presses Close *@
                @if (playsLeft <= 0 && !gameFinished)
                {
                    <div class="alert alert-warning mb-0">
                        You have used all plays for today. Come back tomorrow or ask admin to reset.
                    </div>
                }
                else if (!gameFinished)
                {
                    <div class="text-muted small mb-2">
                        Pick 1 of 3 cards. One contains the voucher.
                    </div>

                    <div class="row g-2">
                        <div class="col-4 d-grid">
                            <button type="button" class="btn btn-outline-primary mg-cardBtn"
                                    disabled="@isPicking"
                                    @onclick="() => PickCard(1)">
                                Card 1
                            </button>
                        </div>
                        <div class="col-4 d-grid">
                            <button type="button" class="btn btn-outline-primary mg-cardBtn"
                                    disabled="@isPicking"
                                    @onclick="() => PickCard(2)">
                                Card 2
                            </button>
                        </div>
                        <div class="col-4 d-grid">
                            <button type="button" class="btn btn-outline-primary mg-cardBtn"
                                    disabled="@isPicking"
                                    @onclick="() => PickCard(3)">
                                Card 3
                            </button>
                        </div>
                    </div>

                    <div class="text-muted small mt-2">
                        Tip: Admin can make it easier 😄
                    </div>
                }
                else
                {
                    <div class="alert @(gameWon ? "alert-success" : "alert-warning") mb-2 mg-reveal">
                        <div class="fw-semibold">@gameTitle</div>
                        <div>@gameMessage</div>
                    </div>

                    @if (gameWon)
                    {
                        <div class="border rounded p-3 bg-light mg-reveal">
                            <div class="text-muted small">Voucher code</div>
                            <div class="fw-bold fs-4">@voucherCode</div>
                            <div class="small text-muted">Discount: @voucherPercent% (demo)</div>
                        </div>
                    }

                    <div class="d-flex gap-2 mt-3">
                        @if (playsLeft > 0)
                        {
                            <button type="button" class="btn btn-primary" @onclick="ResetGame">
                                Play again (left: @playsLeft)
                            </button>
                        }
                        else
                        {
                            <span class="text-muted small align-self-center">
                                No plays left today.
                            </span>
                        }
                    </div>
                }
            </div>
        </div>
    }
</CascadingAuthenticationState>

@code {
    private bool isLoading = true;
    private List<Event> events = new();

    private string searchText = "";
    private string modeFilter = "";

    private bool showGameModal;
    private bool gameFinished;
    private bool gameWon;
    private bool isPicking;

    private string gameTitle = "";
    private string gameMessage = "";
    private string voucherCode = "";
    private int voucherPercent;

    private const int PlaysPerDay = 2;

    private const string KeyLastPopupDate = "erw_game_lastPopup_yyyymmdd";
    private const string KeyPlaysDate = "erw_game_playsDate_yyyymmdd";
    private const string KeyPlaysLeft = "erw_game_playsLeft";
    private const string KeyLostOnceToday = "erw_game_lostOnceToday";
    private const string KeyVoucherWallet = "erw_game_wallet";

    private int playsLeft;

    private string? adminMsg;
    private int adminWinBoostPct = 20;
    private bool adminGuaranteeSecondWin = true;

    private List<VoucherItem> voucherWallet = new();

    private IEnumerable<Event> FilteredEvents =>
        events
            .Where(e =>
                e.IsPublished
                && !e.IsCancelled
                && (string.IsNullOrWhiteSpace(searchText)
                    || (e.Title?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)
                    || (e.Description?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false))
                && (string.IsNullOrWhiteSpace(modeFilter)
                    || (modeFilter == "Online" && e.IsOnline)
                    || (modeFilter == "Physical" && !e.IsOnline)))
            .OrderBy(e => e.StartDate);

    protected override async Task OnInitializedAsync()
    {
        events = await Db.Events.AsNoTracking().ToListAsync();
        isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await LoadOrResetDailyPlays();
        await LoadWallet();

        var today = TodayKey();
        var lastPopup = await JS.InvokeAsync<string?>("localStorage.getItem", KeyLastPopupDate);

        if (!string.Equals(lastPopup, today, StringComparison.Ordinal))
        {
            showGameModal = true;
            await JS.InvokeVoidAsync("localStorage.setItem", KeyLastPopupDate, today);
            await ResetGame();
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ClearFilters()
    {
        searchText = "";
        modeFilter = "";
    }

    private void GoDetails(int id) => Nav.NavigateTo($"/events/details/{id}");

    private async Task OpenGame()
    {
        await LoadOrResetDailyPlays();
        await LoadWallet();
        showGameModal = true;
        await ResetGame();
        await InvokeAsync(StateHasChanged);
    }

    private Task CloseGame()
    {
        showGameModal = false;
        return Task.CompletedTask;
    }

    private async Task LoadOrResetDailyPlays()
    {
        var today = TodayKey();
        var playsDate = await JS.InvokeAsync<string?>("localStorage.getItem", KeyPlaysDate);

        if (!string.Equals(playsDate, today, StringComparison.Ordinal))
        {
            playsLeft = PlaysPerDay;
            await JS.InvokeVoidAsync("localStorage.setItem", KeyPlaysDate, today);
            await JS.InvokeVoidAsync("localStorage.setItem", KeyPlaysLeft, playsLeft.ToString());
            await JS.InvokeVoidAsync("localStorage.setItem", KeyLostOnceToday, "0");
            return;
        }

        var leftStr = await JS.InvokeAsync<string?>("localStorage.getItem", KeyPlaysLeft);
        if (!int.TryParse(leftStr, out playsLeft) || playsLeft < 0) playsLeft = PlaysPerDay;
    }

    private Task SavePlaysLeft()
        => JS.InvokeVoidAsync("localStorage.setItem", KeyPlaysLeft, Math.Max(0, playsLeft).ToString()).AsTask();

    private static string TodayKey() => $"{DateTime.Now:yyyyMMdd}";

    private async Task ResetGame()
    {
        await LoadOrResetDailyPlays();
        gameFinished = false;
        gameWon = false;
        isPicking = false;
        gameTitle = "";
        gameMessage = "";
        voucherCode = "";
        voucherPercent = 0;
    }

    private double CurrentWinChance()
    {
        var chance = 0.35;
        chance += adminWinBoostPct / 100.0;
        if (chance < 0.05) chance = 0.05;
        if (chance > 0.95) chance = 0.95;
        return chance;
    }

    private async Task<bool> LostOnceToday()
    {
        var v = await JS.InvokeAsync<string?>("localStorage.getItem", KeyLostOnceToday);
        return string.Equals(v, "1", StringComparison.Ordinal);
    }

    private Task SetLostOnceToday(bool val)
        => JS.InvokeVoidAsync("localStorage.setItem", KeyLostOnceToday, val ? "1" : "0").AsTask();

    private async Task PickCard(int picked)
    {
        if (isPicking) return;
        isPicking = true;

        try
        {
            await LoadOrResetDailyPlays();
            if (playsLeft <= 0) return;

            playsLeft--;
            await SavePlaysLeft();

            var baseChance = CurrentWinChance();
            var win = Random.Shared.NextDouble() < baseChance;

            // If admin wants guaranteed 2nd try win:
            if (adminGuaranteeSecondWin)
            {
                var lostOnce = await LostOnceToday();
                if (lostOnce) win = true;
                else if (!win) await SetLostOnceToday(true);
            }

            gameFinished = true;

            if (win)
            {
                gameWon = true;
                voucherPercent = Random.Shared.Next(10, 31);
                voucherCode = $"DEMO{voucherPercent}";
                gameTitle = "You won 🎉";
                gameMessage = "Voucher unlocked for demo.";
                await AddVoucherToWallet(voucherCode, voucherPercent);
            }
            else
            {
                gameWon = false;
                gameTitle = "Not this time 😭";
                gameMessage = "Try again if you still have plays left today.";
            }

            await InvokeAsync(StateHasChanged);
        }
        finally
        {
            isPicking = false;
        }
    }

    private async Task ResetDailyGameToTwoPlays()
    {
        adminMsg = null;

        var today = TodayKey();
        playsLeft = PlaysPerDay;

        await JS.InvokeVoidAsync("localStorage.setItem", KeyPlaysDate, today);
        await JS.InvokeVoidAsync("localStorage.setItem", KeyPlaysLeft, PlaysPerDay.ToString());
        await JS.InvokeVoidAsync("localStorage.setItem", KeyLostOnceToday, "0");

        adminMsg = "Daily mini game reset to 2 plays for today on this browser.";
        await ResetGame();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadWallet()
    {
        try
        {
            var json = await JS.InvokeAsync<string?>("localStorage.getItem", KeyVoucherWallet);
            voucherWallet =
                string.IsNullOrWhiteSpace(json)
                ? new List<VoucherItem>()
                : (System.Text.Json.JsonSerializer.Deserialize<List<VoucherItem>>(json) ?? new List<VoucherItem>());
        }
        catch
        {
            voucherWallet = new List<VoucherItem>();
        }
    }

    private Task SaveWallet()
    {
        var json = System.Text.Json.JsonSerializer.Serialize(voucherWallet);
        return JS.InvokeVoidAsync("localStorage.setItem", KeyVoucherWallet, json).AsTask();
    }

    private async Task AddVoucherToWallet(string code, int percent)
    {
        await LoadWallet();

        voucherWallet.Insert(0, new VoucherItem { Code = code, Percent = percent, CreatedOn = DateTime.Now });

        if (voucherWallet.Count > 25)
            voucherWallet = voucherWallet.Take(25).ToList();

        await SaveWallet();
    }

    public class VoucherItem
    {
        public string Code { get; set; } = "";
        public int Percent { get; set; }
        public DateTime CreatedOn { get; set; }
    }

    private static string Shorten(string? text, int max)
    {
        if (string.IsNullOrWhiteSpace(text)) return "";
        text = text.Trim();
        return text.Length <= max ? text : text.Substring(0, max) + "...";
    }

    @* ====== SHARED “EFFECTIVE” FILL LOGIC (prevents stats mismatch) ====== *@
    private static int EffectiveFillPercent(Event ev)
    {
        if (ev.DemoFillPercent.HasValue)
            return Clamp(ev.DemoFillPercent.Value, 0, 100);

        if (ev.Capacity <= 0) return 0;

        var sold = Math.Max(0, ev.TicketsSold);
        sold = Math.Min(sold, ev.Capacity);

        var pct = (int)Math.Round((sold / (double)ev.Capacity) * 100.0);
        return Clamp(pct, 0, 100);
    }

    private static (string label, string cls) AvailabilityBadge(int pct)
    {
        if (pct >= 100) return ("Full", "bg-danger");
        if (pct >= 80) return ("Selling fast", "bg-warning text-dark");
        return ("Available", "bg-success");
    }

    private static int FillPercentForBadges(Event ev) => EffectiveFillPercent(ev);

    private static string PopularityFace(Event ev)
    {
        var p = FillPercentForBadges(ev);
        if (p < 20) return "😐";
        if (p < 50) return "🙂";
        if (p < 80) return "😄";
        return "🤩";
    }

    private static string PopularityLabel(Event ev)
    {
        var p = FillPercentForBadges(ev);
        if (p < 20) return "New";
        if (p < 50) return "Gaining";
        if (p < 80) return "Popular";
        return "Hot";
    }

    private static string TicketPriceText(Event ev)
    {
        var min = ev.TicketPriceMin;
        var max = ev.TicketPriceMax;
        var def = ev.TicketPriceDefault;

        if (min <= 0 && max <= 0 && def <= 0) return "Free";
        if (min > 0 && max > 0 && min == max) return $"SGD {min:0.00}";
        if (min > 0 && max > 0 && min != max) return $"From SGD {min:0.00}";
        if (def > 0) return $"SGD {def:0.00}";
        if (min > 0) return $"From SGD {min:0.00}";
        if (max > 0) return $"SGD {max:0.00}";
        return "Free";
    }

    private static int Clamp(int v, int min, int max)
    {
        if (v < min) return min;
        if (v > max) return max;
        return v;
    }
}
