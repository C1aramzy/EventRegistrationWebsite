@page "/events/delete/{id:int}"
@rendermode InteractiveServer

@using System
@using System.Linq

@using EventRegistrationWebsite.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization

@inject EventRegistrationWebsite.Data.ApplicationDbContext Db
@inject NavigationManager Navigation


<h3>Delete Event</h3>

@if (isLoading)
{
    <p>Loading...</p>
}
else if (eventItem == null)
{
    <div class="alert alert-warning">Event not found.</div>
    <a class="btn btn-secondary" href="/events">Back</a>
}
else
{
    <div class="alert alert-danger">
        <div class="fw-semibold">Confirm delete</div>
        <div>This action cannot be undone.</div>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start gap-3">
                <div>
                    <div class="fw-semibold fs-5">@eventItem.Title</div>
                    <div class="text-muted small">
                        @eventItem.StartDate.ToString("dd MMM yyyy") to @eventItem.EndDate.ToString("dd MMM yyyy")
                    </div>

                    <div class="mt-2 d-flex flex-wrap gap-2">
                        <span class="badge bg-secondary">@eventItem.ComputedStatus</span>

                        @if (eventItem.IsCancelled)
                        {
                            <span class="badge bg-danger">Cancelled</span>
                        }
                        else if (!eventItem.IsPublished)
                        {
                            <span class="badge bg-dark">Draft</span>
                        }

                        @if (eventItem.IsOnline)
                        {
                            <span class="badge bg-info">Online</span>
                        }
                        else
                        {
                            <span class="badge bg-dark">Physical</span>
                        }

                        @if (!string.IsNullOrWhiteSpace(eventItem.EventVibe))
                        {
                            <span class="badge bg-light text-dark border">@eventItem.EventVibe</span>
                        }

                        @if (IsBeginnerFriendly)
                        {
                            <span class="badge bg-success">Beginner Friendly</span>
                        }

                        <span class="badge bg-primary">
                            <span style="font-size:1.05rem">@Popularity.Face</span>
                            <span class="ms-1">@Popularity.Label</span>
                        </span>

                        @if (eventItem.DemoFillPercent.HasValue)
                        {
                            <span class="badge bg-primary">Demo mode</span>
                        }
                    </div>
                </div>

                <div class="text-end">
                    <div class="text-muted small">Last updated</div>
                    <div>@eventItem.LastUpdatedOn.ToString("dd/MM/yyyy HH:mm")</div>
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(eventItem.Description))
            {
                <div class="mt-3 text-muted">
                    @Shorten(eventItem.Description, 160)
                </div>
            }
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(errorMsg))
    {
        <div class="alert alert-warning">@errorMsg</div>
    }

    <div class="d-flex gap-2">
        <button type="button"
                class="btn btn-danger"
                @onclick="ConfirmDelete"
                @onclick:preventDefault="true"
                disabled="@isDeleting">
            @(isDeleting ? "Deleting..." : "Delete")
        </button>

        <a class="btn btn-secondary" href="/events">Cancel</a>
    </div>
}

@code {
    [Parameter] public int id { get; set; }

    private Event? eventItem;
    private bool isLoading = true;
    private bool isDeleting = false;
    private string? errorMsg;

    protected override async Task OnInitializedAsync()
    {
        eventItem = await Db.Events.FirstOrDefaultAsync(e => e.EventID == id);
        isLoading = false;
    }

    private bool IsBeginnerFriendly =>
        eventItem != null && string.Equals(eventItem.EventVibe, "Beginner Friendly", StringComparison.OrdinalIgnoreCase);

    private (string Face, string Label) Popularity
    {
        get
        {
            if (eventItem == null) return ("😐", "New");

            if (eventItem.Capacity <= 0 && eventItem.DemoFillPercent.HasValue == false)
            {
                return ("🙂", "Open");
            }

            var p = FillPercent;

            if (p < 20) return ("😐", "New");
            if (p < 50) return ("🙂", "Gaining");
            if (p < 80) return ("😄", "Popular");
            return ("🤩", "Hot");
        }
    }

    private int FillPercent
    {
        get
        {
            if (eventItem == null) return 0;

            if (eventItem.DemoFillPercent.HasValue)
            {
                return Clamp(eventItem.DemoFillPercent.Value, 0, 100);
            }

            if (eventItem.Capacity > 0)
            {
                return 35;
            }

            return 0;
        }
    }

    private async Task ConfirmDelete()
    {
        if (isDeleting) return;

        errorMsg = null;
        isDeleting = true;

        try
        {
            if (eventItem != null)
            {
                Db.Events.Remove(eventItem);
                await Db.SaveChangesAsync();
            }

            Navigation.NavigateTo("/events", true);
        }
        catch
        {
            errorMsg = "Delete failed. Please try again.";
            isDeleting = false;
        }
    }

    private static int Clamp(int v, int min, int max)
    {
        if (v < min) return min;
        if (v > max) return max;
        return v;
    }

    private static string Shorten(string? text, int max)
    {
        if (string.IsNullOrWhiteSpace(text)) return "";
        text = text.Trim();
        return text.Length <= max ? text : text.Substring(0, max) + "...";
    }
}
