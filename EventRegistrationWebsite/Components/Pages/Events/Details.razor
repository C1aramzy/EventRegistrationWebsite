@page "/events/details/{id:int}"
@rendermode InteractiveServer

@using System
@using System.Linq
@using System.Collections.Generic

@using EventRegistrationWebsite.Models
@using Microsoft.AspNetCore.Authorization
@inject EventRegistrationWebsite.Data.ApplicationDbContext Db
@inject NavigationManager Nav
@inject Microsoft.JSInterop.IJSRuntime JS


@if (eventItem == null)
{
    <div class="alert alert-warning">Event not found.</div>
    <a class="btn btn-secondary" href="/events">Back</a>
}
else
{
    <div class="d-flex align-items-start justify-content-between mb-3">
        <div>
            <h2 class="mb-1">@eventItem.Title</h2>

            <div class="text-muted">
                @if (!string.IsNullOrWhiteSpace(DisplayType))
                {
                    <span class="me-2">Category: <span class="fw-semibold">@DisplayType</span></span>
                }
            </div>

            <div class="mt-2 d-flex flex-wrap gap-2">
                <span class="badge bg-secondary">@eventItem.ComputedStatus</span>

                @if (eventItem.IsCancelled)
                {
                    <span class="badge bg-danger">Cancelled</span>
                }
                else if (!eventItem.IsPublished)
                {
                    <span class="badge bg-dark">Draft</span>
                }

                @if (eventItem.IsOnline)
                {
                    <span class="badge bg-info">Online</span>
                }
                else
                {
                    <span class="badge bg-dark">Physical</span>
                }

                @if (!string.IsNullOrWhiteSpace(eventItem.EventVibe))
                {
                    <span class="badge bg-light text-dark border">@eventItem.EventVibe</span>
                }

                @if (IsBeginnerFriendly)
                {
                    <span class="badge bg-success">Beginner Friendly</span>
                }

                <span class="badge bg-primary">
                    <span style="font-size:1.05rem">@Popularity.Face</span>
                    <span class="ms-1">@Popularity.Label</span>
                </span>

                @if (!string.IsNullOrWhiteSpace(UrgencyText))
                {
                    <span class="badge bg-warning text-dark">@UrgencyText</span>
                }

                @if (!string.IsNullOrWhiteSpace(CountdownText))
                {
                    <span class="badge bg-success">@CountdownText</span>
                }

                @if (eventItem.DemoFillPercent.HasValue)
                {
                    <span class="badge bg-primary">Demo mode</span>
                }

                @if (hasVoucher)
                {
                    <span class="badge bg-success">Voucher unlocked</span>
                }
            </div>
        </div>

        <div class="text-end">
            <div class="text-muted small">Last updated</div>
            <div>@eventItem.LastUpdatedOn.ToString("dd/MM/yyyy HH:mm")</div>

            <div class="mt-2 d-flex justify-content-end gap-2 flex-wrap">
                <button class="btn btn-outline-secondary btn-sm" @onclick="CopyLink">Share</button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="GoEdit">Edit</button>
                <button class="btn btn-outline-danger btn-sm" @onclick="GoDelete">Delete</button>

                <div class="dropdown">
                    <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        ⋯
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <button type="button" class="dropdown-item" @onclick="ToggleDemoPanel">
                                Demo Controls
                            </button>
                        </li>
                        <li>
                            <button type="button" class="dropdown-item" @onclick="ToggleMiniGamePanel">
                                Voucher Mini Game
                            </button>
                        </li>
                    </ul>
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(shareMsg))
            {
                <div class="small text-success mt-1">@shareMsg</div>
            }
        </div>
    </div>

    @if (showDemoPanel)
    {
        <div class="card mb-3 border-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start gap-3">
                    <div>
                        <div class="fw-semibold">Demo Controls</div>
                        <div class="text-muted small">
                            Fake how full the event is for presentation. This affects UI only.
                        </div>
                    </div>

                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="ToggleDemoPanel">
                        Close
                    </button>
                </div>

                <div class="row g-2 mt-2">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Demo fullness percent (0 to 100)</label>
                        <input type="number"
                               class="form-control"
                               min="0"
                               max="100"
                               value="@demoFillText"
                               @oninput="OnDemoFillInput" />
                        <div class="form-text">
                            Leave blank to clear demo mode.
                        </div>
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label">Preview</label>
                        <div class="p-3 rounded bg-light border">
                            <div class="d-flex justify-content-between">
                                <div class="text-muted small">Fill</div>
                                <div class="fw-semibold">@FillPercentDisplay</div>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <div class="text-muted small">Popularity</div>
                                <div class="fw-semibold">
                                    <span style="font-size:1.1rem">@PopularityPreview.Face</span>
                                    <span class="ms-1">@PopularityPreview.Label</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <div class="text-muted small">Urgency</div>
                                <div class="fw-semibold">@UrgencyPreview</div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" @onclick="SaveDemoFillToDb" disabled="@isSavingDemo">
                                @(isSavingDemo ? "Saving" : "Save")
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" @onclick="ClearDemoFillAndSave" disabled="@isSavingDemo">
                                Clear demo mode
                            </button>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(demoMsg))
                        {
                            <div class="small text-success mt-2">@demoMsg</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @if (showMiniGamePanel)
    {
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start gap-3">
                    <div>
                        <div class="fw-semibold">Voucher Mini Game</div>
                        <div class="text-muted small">
                            Pick the correct box to unlock a mock voucher for this event.
                        </div>
                    </div>

                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="ToggleMiniGamePanel">
                        Close
                    </button>
                </div>

                @if (hasVoucher)
                {
                    <div class="alert alert-success mt-3 mb-0">
                        <div class="fw-semibold">You unlocked a voucher!</div>
                        <div class="mt-1">Code: <span class="fw-semibold">@voucherCode</span></div>
                        <div class="small mt-1">@voucherEffectText</div>
                    </div>
                }
                else
                {
                    <div class="mt-3">
                        <div class="text-muted small">Choose one</div>

                        <div class="d-flex gap-2 flex-wrap mt-2">
                            <button type="button" class="btn btn-outline-primary" @onclick="() => PickBox(1)" disabled="@miniGameLocked">Box 1</button>
                            <button type="button" class="btn btn-outline-primary" @onclick="() => PickBox(2)" disabled="@miniGameLocked">Box 2</button>
                            <button type="button" class="btn btn-outline-primary" @onclick="() => PickBox(3)" disabled="@miniGameLocked">Box 3</button>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(miniGameMsg))
                        {
                            <div class="mt-2">@miniGameMsg</div>
                        }

                        <div class="form-text mt-2">
                            This is a demo mini game. Real voucher logic can be wired to user accounts later.
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <div class="row g-3">
        <div class="col-12 col-lg-7">
            <div class="card">
                <img src="@(string.IsNullOrWhiteSpace(eventItem.BannerImagePath) ? "/images/placeholder-eventPic.png" : eventItem.BannerImagePath)"
                     class="img-fluid rounded-top"
                     style="max-height: 320px; width: 100%; object-fit: cover;"
                     alt="Event banner" />

                <div class="card-body">
                    @if (!string.IsNullOrWhiteSpace(eventItem.Summary))
                    {
                        <p class="lead mb-2">@eventItem.Summary</p>
                    }

                    <h5 class="mb-2">About this event</h5>
                    @if (!string.IsNullOrWhiteSpace(eventItem.Description))
                    {
                        <p class="mb-0">@eventItem.Description</p>
                    }
                    else
                    {
                        <div class="text-muted">No description provided.</div>
                    }
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="mb-3">Date and time</h5>

                    <div class="row g-2">
                        <div class="col-12 col-md-6">
                            <div class="text-muted small">Start</div>
                            <div class="fw-semibold">@eventItem.StartDate.ToString("dd MMM yyyy") @FormatTime(eventItem.StartTime)</div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="text-muted small">End</div>
                            <div class="fw-semibold">@eventItem.EndDate.ToString("dd MMM yyyy") @FormatTime(eventItem.EndTime)</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="mb-3">Location</h5>

                    @if (eventItem.IsOnline)
                    {
                        <div class="text-muted small">Online link</div>
                        @if (!string.IsNullOrWhiteSpace(eventItem.OnlineEventUrl))
                        {
                            <a class="fw-semibold" href="@eventItem.OnlineEventUrl" target="_blank">@eventItem.OnlineEventUrl</a>
                        }
                        else
                        {
                            <div class="text-muted">No URL provided.</div>
                        }
                    }
                    else
                    {
                        <div class="fw-semibold">@Coalesce(eventItem.VenueName, "Venue not provided")</div>
                        <div class="text-muted">@Coalesce(eventItem.VenueAddress, "Address not provided")</div>

                        <div class="mt-2">
                            @if (!string.IsNullOrWhiteSpace(eventItem.UnitRoom))
                            {
                                <div>Unit or room: <span class="fw-semibold">@eventItem.UnitRoom</span></div>
                            }
                            @if (!string.IsNullOrWhiteSpace(eventItem.PostalCode))
                            {
                                <div>Postal code: <span class="fw-semibold">@eventItem.PostalCode</span></div>
                            }
                        </div>

                        <div class="mt-3 d-flex gap-2 flex-wrap">
                            <a class="btn btn-outline-secondary btn-sm" href="@GoogleMapsLink" target="_blank">Open in Google Maps</a>
                            <a class="btn btn-outline-secondary btn-sm" href="@OneMapLink" target="_blank">Open in OneMap</a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-5">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">Ticketing</h5>

                    @if (!eventItem.TicketingEnabled || eventItem.IsCancelled)
                    {
                        <div class="text-muted">Ticketing is unavailable for this event.</div>
                    }
                    else
                    {
                        <div class="mb-2">
                            <div class="text-muted small">Ticket price (SGD)</div>
                            <div class="fw-bold fs-4">@TicketDisplayText</div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <div class="text-muted small">Capacity</div>
                                <div class="fw-semibold">@CapacityText</div>
                            </div>

                            @if (eventItem.Capacity > 0)
                            {
                                <div class="progress mt-2" style="height: 10px;">
                                    <div class="progress-bar" style="width:@CapacityBarPercent%"></div>
                                </div>

                                <div class="small text-muted mt-1">
                                    Display uses demo fullness when demo mode is set.
                                </div>
                            }
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number"
                                   class="form-control"
                                   min="1"
                                   max="@MaxSelectableQty"
                                   value="@selectedQty"
                                   @oninput="OnQtyInput" />

                            <div class="small text-muted mt-1">
                                Max per order: @eventItem.MaxTicketsPerOrder
                                @if (eventItem.Capacity > 0)
                                {
                                    <span class="ms-2">Capacity: @eventItem.Capacity</span>
                                }
                            </div>
                        </div>

                        <div class="border rounded p-3 bg-light">
                            @if (eventItem.IsOnline)
                            {
                                <div class="fw-semibold">Online event</div>

                                @if (!string.IsNullOrWhiteSpace(eventItem.OnlineEventUrl))
                                {
                                    <div class="small text-muted mt-1">Join link</div>
                                    <a class="fw-semibold" href="@eventItem.OnlineEventUrl" target="_blank">
                                        @eventItem.OnlineEventUrl
                                    </a>
                                }
                                else
                                {
                                    <div class="text-muted small mt-1">No link provided.</div>
                                }
                            }
                            else
                            {
                                <div class="fw-semibold mb-2">How do you want to get there?</div>

                                <div class="row g-3">
                                    <div class="col-12 col-md-6">
                                        <div class="d-grid gap-2">
                                            <a class="btn btn-outline-secondary" href="@DirectionsLink("driving")" target="_blank">
                                                🚗 Driving
                                            </a>
                                            <a class="btn btn-outline-secondary" href="@DirectionsLink("transit")" target="_blank">
                                                🚌 Public transport
                                            </a>
                                            <a class="btn btn-outline-secondary" href="@DirectionsLink("bicycling")" target="_blank">
                                                🚲 Biking
                                            </a>
                                            <a class="btn btn-outline-secondary" href="@DirectionsLink("walking")" target="_blank">
                                                🚶 Walking
                                            </a>
                                        </div>

                                        <div class="small text-muted mt-2">
                                            Opens Google Maps directions from your current location.
                                        </div>
                                    </div>

                                    <div class="col-12 col-md-6">
                                        <div class="border rounded bg-white p-3 h-100 d-flex align-items-center justify-content-center"
                                             style="min-height: 180px;">
                                            <div class="text-center">
                                                <div class="text-muted small mb-2">Map</div>
                                                <div class="d-flex gap-2 justify-content-center flex-wrap">
                                                    <a class="btn btn-primary" href="@OneMapLink" target="_blank">Show map</a>
                                                    <a class="btn btn-outline-secondary" href="@GoogleMapsLink" target="_blank">Google Maps</a>
                                                </div>
                                                <div class="small text-muted mt-2">
                                                    Uses your existing map links.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                    }
                </div>
            </div>

            <div class="mt-3">
                <a class="btn btn-secondary w-100" href="/events">Back to events</a>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }
    private Event? eventItem;

    private int selectedQty = 1;
    private string? shareMsg;

    private bool showDemoPanel = false;
    private string demoFillText = "";
    private bool isSavingDemo = false;
    private string? demoMsg;

    // Mini game
    private bool showMiniGamePanel = false;
    private bool miniGameLocked = false;
    private string? miniGameMsg;
    private bool hasVoucher = false;
    private string voucherCode = "";
    private string voucherEffectText = "10 percent off for demo display";

    protected override void OnInitialized()
    {
        eventItem = Db.Events.FirstOrDefault(e => e.EventID == id);
        selectedQty = 1;

        demoFillText = eventItem?.DemoFillPercent.HasValue == true ? eventItem.DemoFillPercent.Value.ToString() : "";

        hasVoucher = false;
        voucherCode = "";
    }

    private string DisplayType =>
        eventItem == null ? "" :
        (eventItem.EventType == "Other"
            ? (eventItem.EventTypeOther ?? "Other")
            : (eventItem.EventType ?? ""));

    private bool IsBeginnerFriendly =>
        eventItem != null && string.Equals(eventItem.EventVibe, "Beginner Friendly", StringComparison.OrdinalIgnoreCase);

    private string CountdownText
    {
        get
        {
            if (eventItem == null) return "";
            if (eventItem.IsCancelled) return "";
            var now = DateTime.Now;
            var start = eventItem.StartDate.Date;
            var days = (start - now.Date).Days;
            if (days > 0) return $"Starts in {days} day(s)";
            if (days == 0 && eventItem.ComputedStatus == "Upcoming") return "Starts today";
            if (eventItem.ComputedStatus == "Ongoing") return "Live now";
            return "";
        }
    }

    private int FillPercent
    {
        get
        {
            if (eventItem == null) return 0;

            if (eventItem.DemoFillPercent.HasValue)
            {
                return Clamp(eventItem.DemoFillPercent.Value, 0, 100);
            }

            if (eventItem.Capacity > 0)
            {
                return 35;
            }

            return 0;
        }
    }

    private (string Face, string Label) Popularity
    {
        get
        {
            if (eventItem == null) return ("😐", "New");

            if (eventItem.Capacity <= 0 && !eventItem.DemoFillPercent.HasValue)
            {
                return ("🙂", "Open");
            }

            var p = FillPercent;

            if (p < 20) return ("😐", "New");
            if (p < 50) return ("🙂", "Gaining");
            if (p < 80) return ("😄", "Popular");
            return ("🤩", "Hot");
        }
    }

    private string UrgencyText
    {
        get
        {
            if (eventItem == null) return "";
            if (eventItem.IsCancelled) return "";
            if (!eventItem.TicketingEnabled) return "";
            if (eventItem.Capacity <= 0 && !eventItem.DemoFillPercent.HasValue) return "";

            var p = FillPercent;
            if (p >= 90) return "Almost full";
            if (p >= 75) return "Selling fast";
            if (p >= 50) return "Limited seats";
            return "";
        }
    }


    private string CapacityText =>
        eventItem == null ? "-" :
        (eventItem.Capacity <= 0 ? "Unlimited" : $"{eventItem.Capacity} seats");

    private int CapacityBarPercent => eventItem?.Capacity > 0 ? FillPercent : 0;

    private int MaxSelectableQty
    {
        get
        {
            if (eventItem == null) return 1;
            var max = Math.Max(1, eventItem.MaxTicketsPerOrder);
            if (eventItem.Capacity > 0)
            {
                max = Math.Min(max, eventItem.Capacity);
            }
            return Math.Max(1, max);
        }
    }

    private decimal UnitPrice
    {
        get
        {
            if (eventItem == null) return 0m;

            var min = eventItem.TicketPriceMin;
            var max = eventItem.TicketPriceMax;
            var def = eventItem.TicketPriceDefault;

            if (min <= 0 && max <= 0 && def <= 0) return 0m;
            if (min > 0 && max > 0 && min == max) return min;
            if (min > 0 && max > 0 && min != max) return min;
            if (def > 0) return def;
            if (min > 0) return min;
            if (max > 0) return max;
            return 0m;
        }
    }

    private string TicketDisplayText
    {
        get
        {
            if (eventItem == null) return "SGD 0.00";

            var min = eventItem.TicketPriceMin;
            var max = eventItem.TicketPriceMax;
            var def = eventItem.TicketPriceDefault;

            if (min <= 0 && max <= 0 && def <= 0) return "Free";
            if (min > 0 && max > 0 && min == max) return $"SGD {min:0.00}";
            if (min > 0 && max > 0 && min != max) return $"From SGD {min:0.00}";
            if (def > 0) return $"SGD {def:0.00}";
            if (min > 0) return $"From SGD {min:0.00}";
            if (max > 0) return $"SGD {max:0.00}";
            return "Free";
        }
    }

    private decimal VoucherMultiplier => hasVoucher ? 0.90m : 1.00m;

    private decimal TotalPrice => UnitPrice * selectedQty * VoucherMultiplier;

    private string GoogleMapsLink
    {
        get
        {
            if (eventItem == null) return "#";
            var q = $"{eventItem.VenueName} {eventItem.VenueAddress} {eventItem.PostalCode}".Trim();
            var enc = Uri.EscapeDataString(q);
            return $"https://www.google.com/maps/search/?api=1&query={enc}";
        }
    }

    private string OneMapLink
    {
        get
        {
            if (eventItem == null) return "#";
            var q = $"{eventItem.PostalCode} {eventItem.VenueAddress}".Trim();
            var enc = Uri.EscapeDataString(q);
            return $"https://www.onemap.gov.sg/main/v2/?searchVal={enc}";
        }
    }

    private static string Coalesce(string? s, string fallback) => string.IsNullOrWhiteSpace(s) ? fallback : s;

    private static string FormatTime(TimeSpan? t)
    {
        if (t == null) return "";
        var dt = DateTime.Today.Add(t.Value);
        return $"({dt:hh:mm tt})";
    }

    private void OnQtyInput(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var v))
        {
            v = Math.Max(1, v);
            v = Math.Min(MaxSelectableQty, v);
            selectedQty = v;
        }
    }

    private async Task CopyLink()
    {
        shareMsg = null;
        var url = Nav.ToAbsoluteUri($"/events/details/{id}").ToString();
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", url);
            shareMsg = "Link copied";
        }
        catch
        {
            shareMsg = "Copy failed";
        }
    }

    private void GoEdit() => Nav.NavigateTo($"/events/edit/{id}");
    private void GoDelete() => Nav.NavigateTo($"/events/delete/{id}");

    private void ToggleDemoPanel()
    {
        showDemoPanel = !showDemoPanel;
        if (showDemoPanel)
        {
            showMiniGamePanel = false;
            demoMsg = null;
        }
    }

    private void OnDemoFillInput(ChangeEventArgs e)
    {
        demoFillText = e.Value?.ToString() ?? "";
        demoMsg = null;
    }

    private string FillPercentDisplay
    {
        get
        {
            if (string.IsNullOrWhiteSpace(demoFillText))
            {
                return eventItem?.DemoFillPercent.HasValue == true ? $"{eventItem.DemoFillPercent.Value}%" : $"{FillPercent}%";
            }

            if (int.TryParse(demoFillText.Trim(), out var v))
            {
                v = Clamp(v, 0, 100);
                return $"{v}%";
            }

            return $"{FillPercent}%";
        }
    }

    private (string Face, string Label) PopularityPreview
    {
        get
        {
            var p = PreviewDemoFillValue;

            if (eventItem == null) return ("😐", "New");
            if (eventItem.Capacity <= 0 && p == null && !eventItem.DemoFillPercent.HasValue) return ("🙂", "Open");

            var value = p ?? FillPercent;

            if (value < 20) return ("😐", "New");
            if (value < 50) return ("🙂", "Gaining");
            if (value < 80) return ("😄", "Popular");
            return ("🤩", "Hot");
        }
    }

    private string UrgencyPreview
    {
        get
        {
            if (eventItem == null) return "-";
            if (eventItem.IsCancelled) return "-";
            if (!eventItem.TicketingEnabled) return "-";

            var p = PreviewDemoFillValue ?? FillPercent;

            if (eventItem.Capacity <= 0 && PreviewDemoFillValue == null && !eventItem.DemoFillPercent.HasValue) return "None";

            if (p >= 90) return "Almost full";
            if (p >= 75) return "Selling fast";
            if (p >= 50) return "Limited seats";
            return "None";
        }
    }

    private int? PreviewDemoFillValue
    {
        get
        {
            if (string.IsNullOrWhiteSpace(demoFillText)) return null;
            if (!int.TryParse(demoFillText.Trim(), out var v)) return null;
            return Clamp(v, 0, 100);
        }
    }

    private async Task SaveDemoFillToDb()
    {
        if (eventItem == null) return;
        if (isSavingDemo) return;

        demoMsg = null;
        isSavingDemo = true;

        try
        {
            if (string.IsNullOrWhiteSpace(demoFillText))
            {
                eventItem.DemoFillPercent = null;
            }
            else if (int.TryParse(demoFillText.Trim(), out var v))
            {
                eventItem.DemoFillPercent = Clamp(v, 0, 100);
                demoFillText = eventItem.DemoFillPercent.Value.ToString();
            }
            else
            {
                demoMsg = "Please enter a number from 0 to 100 or clear the field";
                return;
            }

            await Db.SaveChangesAsync();
            demoMsg = "Saved";
        }
        finally
        {
            isSavingDemo = false;
        }
    }

    private async Task ClearDemoFillAndSave()
    {
        demoFillText = "";
        await SaveDemoFillToDb();
    }

    private void ToggleMiniGamePanel()
    {
        showMiniGamePanel = !showMiniGamePanel;
        if (showMiniGamePanel)
        {
            showDemoPanel = false;
            miniGameMsg = null;
            miniGameLocked = false;
        }
    }

    private void PickBox(int chosen)
    {
        if (hasVoucher) return;
        if (miniGameLocked) return;

        miniGameLocked = true;

        var seed = (id * 397) ^ DateTime.Today.DayOfYear;
        var winner = (Math.Abs(seed) % 3) + 1;

        if (chosen == winner)
        {
            hasVoucher = true;
            voucherCode = $"DEMO{id:0000}10";
            voucherEffectText = "Mock voucher: 10 percent off on the total display";
            miniGameMsg = "You got it. Voucher unlocked.";
        }
        else
        {
            miniGameMsg = "Not this one. Try again by reopening the panel.";
        }
    }

    private static int Clamp(int v, int min, int max)
    {
        if (v < min) return min;
        if (v > max) return max;
        return v;
    }
    private string DirectionsLink(string mode)
    {
        if (eventItem == null) return "/events";

        var dest = DestinationQuery;
        return $"https://www.google.com/maps/dir/?api=1&origin=My+Location&destination={dest}&travelmode={mode}";
    }

    private string DestinationQuery
    {
        get
        {
            if (eventItem == null) return "";

            var parts = new List<string>();

            if (!string.IsNullOrWhiteSpace(eventItem.VenueName)) parts.Add(eventItem.VenueName);
            if (!string.IsNullOrWhiteSpace(eventItem.VenueAddress)) parts.Add(eventItem.VenueAddress);
            if (!string.IsNullOrWhiteSpace(eventItem.PostalCode)) parts.Add(eventItem.PostalCode);

            var raw = string.Join(" ", parts);
            return Uri.EscapeDataString(raw);
        }
    }

}
