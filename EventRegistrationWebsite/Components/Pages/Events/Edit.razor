@page "/events/edit/{id:int}"
@rendermode InteractiveServer

@using System
@using System.IO
@using System.Linq
@using System.Collections.Generic
@using System.Threading
@using System.Threading.Tasks
@using System.Globalization

@using EventRegistrationWebsite.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using EventRegistrationWebsite.Services
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage

@inject ProtectedLocalStorage LocalStore
@inject EventRegistrationWebsite.Data.ApplicationDbContext Db
@inject NavigationManager Navigation
@inject IWebHostEnvironment Env
@inject OneMapService OneMap

@attribute [Authorize(Roles = "Admin")]

<div class="d-flex align-items-center justify-content-between mb-2">
    <h3 class="mb-0">Edit Event</h3>

    <div class="dropdown">
        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            ⋯
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            <li>
                <button type="button" class="dropdown-item text-danger" @onclick="GoDelete">
                    Delete
                </button>
            </li>
        </ul>
    </div>
</div>

@if (eventModel == null)
{
    <div class="alert alert-warning">Event not found.</div>
    <a class="btn btn-secondary" href="/events">Back</a>
}
else
{
    <EditForm Model="@eventModel" OnValidSubmit="Update" FormName="EditEventForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row g-3">
            <div class="col-12 col-lg-7">
                <div class="card">
                    <div class="card-body">

                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <InputText class="form-control" @bind-Value="eventModel.Title" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Summary (short tagline)</label>
                            <InputText class="form-control" @bind-Value="eventModel.Summary" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <InputTextArea class="form-control" @bind-Value="eventModel.Description" rows="5" />
                        </div>

                        <div class="row g-2">
                            <div class="col-12 col-md-6">
                                <label class="form-label">Start Date</label>
                                <InputDate class="form-control" @bind-Value="eventModel.StartDate" />
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">End Date</label>
                                <InputDate class="form-control" @bind-Value="eventModel.EndDate" />
                            </div>
                        </div>

                        <div class="row g-2 mt-2">
                            <div class="col-12 col-md-6">
                                <label class="form-label">Start Time</label>
                                <input type="time"
                                       class="form-control"
                                       value="@startTimeText"
                                       @oninput="OnStartTimeInput" />
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">End Time</label>
                                <input type="time"
                                       class="form-control"
                                       value="@endTimeText"
                                       @oninput="OnEndTimeInput" />
                            </div>
                        </div>

                        <hr class="my-4" />

                        <div class="row g-2">
                            <div class="col-12 col-md-6">
                                <label class="form-label">Event Type</label>
                                <select class="form-select" value="@eventModel.EventType" @onchange="OnEventTypeChanged">
                                    <option value="">Select one</option>
                                    <option value="Workshop">Workshop</option>
                                    <option value="Training">Training</option>
                                    <option value="Seminar">Seminar</option>
                                    <option value="Trial Session">Trial Session</option>
                                    <option value="Competition">Competition</option>
                                    <option value="Networking">Networking</option>
                                    <option value="Open House">Open House</option>
                                    <option value="Performance">Performance</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Vibe</label>
                                <select class="form-select" @bind="eventModel.EventVibe">
                                    <option value="">Optional</option>
                                    <option value="Beginner Friendly">Beginner Friendly</option>
                                    <option value="Hands On">Hands On</option>
                                    <option value="Chill">Chill</option>
                                    <option value="High Energy">High Energy</option>
                                    <option value="Formal">Formal</option>
                                    <option value="Team Based">Team Based</option>
                                    <option value="Family Friendly">Family Friendly</option>
                                </select>
                            </div>
                        </div>

                        @if (eventModel.EventType == "Other")
                        {
                            <div class="mt-2">
                                <label class="form-label">Specify Event Type</label>
                                <InputText class="form-control" @bind-Value="eventModel.EventTypeOther" />
                            </div>
                        }

                        <hr class="my-4" />

                        <div class="mb-3">
                            <label class="form-label">Publish</label>
                            <div class="form-check">
                                <InputCheckbox class="form-check-input" @bind-Value="eventModel.IsPublished" />
                                <label class="form-check-label">Visible to users</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cancelled</label>
                            <div class="form-check">
                                <InputCheckbox class="form-check-input" @bind-Value="eventModel.IsCancelled" />
                                <label class="form-check-label">Mark event as Cancelled</label>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="mb-3">Banner Image</h5>

                        <InputFile OnChange="OnBannerSelected" accept="image/*" />

                        @if (!string.IsNullOrWhiteSpace(uploadError))
                        {
                            <div class="text-danger mt-2">@uploadError</div>
                        }

                        @if (!string.IsNullOrWhiteSpace(previewImageUrl))
                        {
                            <div class="mt-2">
                                <img src="@previewImageUrl"
                                     style="max-width: 100%; max-height: 260px; object-fit: cover;" />
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-5">
                <div class="card">
                    <div class="card-body">
                        <h5 class="mb-3">Location</h5>

                        <div class="form-check mb-2">
                            <InputCheckbox class="form-check-input" @bind-Value="eventModel.IsOnline" />
                            <label class="form-check-label">Online Event</label>
                        </div>

                        @if (eventModel.IsOnline)
                        {
                            <div class="mb-3">
                                <label class="form-label">Online Event URL</label>
                                <InputText class="form-control" @bind-Value="eventModel.OnlineEventUrl" />
                            </div>
                        }
                        else
                        {
                            <div class="mb-3 position-relative">
                                <label class="form-label">Search Venue or Postal Code (OneMap)</label>

                                <div class="input-group">
                                    <input class="form-control"
                                           value="@venueSearch"
                                           placeholder="Eg 486150 or Singapore Expo"
                                           @oninput="OnVenueInput" />

                                    <button type="button" class="btn btn-outline-secondary" @onclick="ManualSearch">
                                        Search
                                    </button>
                                </div>

                                @if (isSuggesting)
                                {
                                    <div class="border rounded mt-1 p-2 bg-white shadow-sm"
                                         style="position:absolute; z-index:1000; width:100%;">
                                        <div class="small text-muted">Searching</div>
                                    </div>
                                }
                                else if (showSuggestions && searchResults.Any())
                                {
                                    <div class="border rounded mt-1 bg-white shadow-sm"
                                         style="position:absolute; z-index:1000; width:100%; max-height:280px; overflow-y:auto;">
                                        @foreach (var r in searchResults.Take(8))
                                        {
                                            <button type="button"
                                                    class="list-group-item list-group-item-action"
                                                    style="border:none; width:100%; text-align:left;"
                                                    @onclick="() => SelectVenue(r)">
                                                <div class="fw-semibold">@DisplayBuilding(r)</div>
                                                <div class="small text-muted">@r.ADDRESS</div>
                                                <div class="small">Postal: @r.POSTAL</div>
                                            </button>
                                        }
                                    </div>
                                }

                                @if (!string.IsNullOrWhiteSpace(searchError))
                                {
                                    <div class="text-danger mt-2">@searchError</div>
                                }
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Venue Name</label>
                                <InputText class="form-control" @bind-Value="eventModel.VenueName" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Venue Address</label>
                                <InputText class="form-control" @bind-Value="eventModel.VenueAddress" />
                            </div>

                            <div class="row g-2">
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Postal Code</label>
                                    <InputText class="form-control" @bind-Value="eventModel.PostalCode" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Unit or Room</label>
                                    <InputText class="form-control" @bind-Value="eventModel.UnitRoom" />
                                </div>
                            </div>
                        }

                        <hr class="my-4" />

                        <h5 class="mb-3">Organiser</h5>

                        <div class="mb-3">
                            <label class="form-label">Organiser Name</label>
                            <InputText class="form-control" @bind-Value="eventModel.OrganizerName" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Contact Email</label>
                            <InputText class="form-control" @bind-Value="eventModel.ContactEmail" />
                        </div>

                        <hr class="my-4" />

                        <h5 class="mb-3">Ticketing</h5>

                        <div class="form-check mb-3">
                            <InputCheckbox class="form-check-input" @bind-Value="eventModel.TicketingEnabled" />
                            <label class="form-check-label">Enable ticketing</label>
                        </div>

                        @if (!eventModel.TicketingEnabled)
                        {
                            <div class="text-muted">Ticketing is turned off for this event</div>
                        }
                        else
                        {
                            <div class="row g-2">
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Capacity (0 = unlimited)</label>
                                    <InputNumber class="form-control" @bind-Value="eventModel.Capacity" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Max tickets per order</label>
                                    <InputNumber class="form-control" @bind-Value="eventModel.MaxTicketsPerOrder" />
                                </div>
                            </div>

                            <div class="row g-2 mt-2">
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Min Price (SGD)</label>
                                    <InputNumber class="form-control" @bind-Value="eventModel.TicketPriceMin" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Max Price (SGD)</label>
                                    <InputNumber class="form-control" @bind-Value="eventModel.TicketPriceMax" />
                                </div>
                            </div>
                        }

                    </div>
                </div>

                <div class="d-grid gap-2 mt-3">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <a class="btn btn-secondary" href="/events">Cancel</a>
                </div>
            </div>
        </div>
    </EditForm>
}

@code {
    [Parameter] public int id { get; set; }

    private Event? eventModel;

    private string? previewImageUrl;
    private string? uploadError;

    private string venueSearch = "";
    private string? searchError;
    private List<OneMapService.OneMapResult> searchResults = new();

    private bool showSuggestions;
    private bool isSuggesting;

    private CancellationTokenSource? debounceCts;
    private string? lastTriggeredQuery;

    private string startTimeText = "";
    private string endTimeText = "";

    protected override async Task OnInitializedAsync()
    {
        eventModel = await Db.Events.FirstOrDefaultAsync(e => e.EventID == id);

        if (eventModel != null)
        {
            previewImageUrl = eventModel.BannerImagePath;
            venueSearch = eventModel.VenueName ?? "";

            startTimeText = eventModel.StartTime.HasValue ? eventModel.StartTime.Value.ToString(@"hh\:mm") : "";
            endTimeText = eventModel.EndTime.HasValue ? eventModel.EndTime.Value.ToString(@"hh\:mm") : "";
        }
    }

    private void GoDelete()
    {
        Navigation.NavigateTo($"/events/delete/{id}");
    }

    private void OnStartTimeInput(ChangeEventArgs e)
    {
        startTimeText = e.Value?.ToString() ?? "";
        if (eventModel == null) return;
        eventModel.StartTime = ParseTimeOrNull(startTimeText);
    }

    private void OnEndTimeInput(ChangeEventArgs e)
    {
        endTimeText = e.Value?.ToString() ?? "";
        if (eventModel == null) return;
        eventModel.EndTime = ParseTimeOrNull(endTimeText);
    }

    private static TimeSpan? ParseTimeOrNull(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return null;
        if (TimeSpan.TryParse(s, CultureInfo.InvariantCulture, out var ts)) return ts;
        return null;
    }

    private void OnEventTypeChanged(ChangeEventArgs e)
    {
        if (eventModel == null) return;

        eventModel.EventType = e.Value?.ToString() ?? "";
        if (eventModel.EventType != "Other")
        {
            eventModel.EventTypeOther = null;
        }
    }

    private async Task OnBannerSelected(InputFileChangeEventArgs e)
    {
        uploadError = null;
        if (eventModel == null) return;

        var file = e.File;
        if (file == null) return;

        var ext = Path.GetExtension(file.Name).ToLowerInvariant();
        var allowed = new[] { ".jpg", ".jpeg", ".png", ".webp" };

        if (!allowed.Contains(ext))
        {
            uploadError = "Only JPG, PNG, or WEBP images are allowed";
            return;
        }

        if (file.Size > 3_000_000)
        {
            uploadError = "Image too large. Max 3MB";
            return;
        }

        var folder = Path.Combine(Env.WebRootPath, "uploads", "events");
        Directory.CreateDirectory(folder);

        var fileName = $"event_{Guid.NewGuid()}{ext}";
        var fullPath = Path.Combine(folder, fileName);

        await using var fs = new FileStream(fullPath, FileMode.Create);
        await file.OpenReadStream(3_000_000).CopyToAsync(fs);

        eventModel.BannerImagePath = $"/uploads/events/{fileName}";
        previewImageUrl = eventModel.BannerImagePath;
    }

    private async Task Update()
    {
        if (eventModel == null) return;

        eventModel.LastUpdatedOn = DateTime.Now;

        if (eventModel.IsOnline)
        {
            eventModel.VenueName = null;
            eventModel.VenueAddress = null;
            eventModel.PostalCode = null;
            eventModel.UnitRoom = null;
        }
        else
        {
            eventModel.OnlineEventUrl = null;
        }

        if (eventModel.EventType != "Other")
        {
            eventModel.EventTypeOther = null;
        }

        if (eventModel.EndDate.Date < eventModel.StartDate.Date)
        {
            eventModel.EndDate = eventModel.StartDate;
        }

        if (!eventModel.TicketingEnabled)
        {
            eventModel.Capacity = 0;
            eventModel.MaxTicketsPerOrder = Math.Max(1, eventModel.MaxTicketsPerOrder);
            eventModel.TicketPriceMin = 0;
            eventModel.TicketPriceMax = 0;
            eventModel.TicketPriceDefault = 0;
        }
        else
        {
            if (eventModel.MaxTicketsPerOrder <= 0) eventModel.MaxTicketsPerOrder = 1;
            if (eventModel.Capacity < 0) eventModel.Capacity = 0;

            if (eventModel.TicketPriceMin < 0) eventModel.TicketPriceMin = 0;
            if (eventModel.TicketPriceMax < 0) eventModel.TicketPriceMax = 0;

            if (eventModel.TicketPriceMin > eventModel.TicketPriceMax && eventModel.TicketPriceMax != 0)
            {
                var tmp = eventModel.TicketPriceMin;
                eventModel.TicketPriceMin = eventModel.TicketPriceMax;
                eventModel.TicketPriceMax = tmp;
            }

            if (eventModel.TicketPriceMin > 0 && eventModel.TicketPriceMax > 0 && eventModel.TicketPriceMin == eventModel.TicketPriceMax)
            {
                eventModel.TicketPriceDefault = eventModel.TicketPriceMin;
            }
            else
            {
                eventModel.TicketPriceDefault = 0;
            }
        }

        await Db.SaveChangesAsync();
        Navigation.NavigateTo("/events");
    }

    private async Task OnVenueInput(ChangeEventArgs e)
    {
        venueSearch = e.Value?.ToString() ?? "";
        searchError = null;

        var qRaw = venueSearch.Trim();

        if (!ShouldTriggerSuggestions(qRaw))
        {
            showSuggestions = false;
            searchResults.Clear();
            lastTriggeredQuery = null;
            return;
        }

        showSuggestions = true;

        debounceCts?.Cancel();
        debounceCts = new CancellationTokenSource();
        var token = debounceCts.Token;

        var isFirstTrigger = string.IsNullOrWhiteSpace(lastTriggeredQuery);

        try
        {
            isSuggesting = true;

            if (!isFirstTrigger)
            {
                await Task.Delay(250, token);
                token.ThrowIfCancellationRequested();
            }

            var results = await OneMap.SearchAsync(qRaw);
            lastTriggeredQuery = qRaw;

            searchResults = results
                .Where(r => !string.IsNullOrWhiteSpace(r.ADDRESS))
                .Take(8)
                .ToList();

            if (searchResults.Count == 0)
            {
                showSuggestions = false;
            }
        }
        catch (OperationCanceledException)
        {
        }
        catch
        {
            searchError = "Unable to contact OneMap right now. Please try again";
            showSuggestions = false;
            searchResults.Clear();
        }
        finally
        {
            isSuggesting = false;
            StateHasChanged();
        }
    }

    private async Task ManualSearch()
    {
        searchError = null;

        var qRaw = venueSearch.Trim();

        if (!ShouldTriggerSuggestions(qRaw))
        {
            searchError = "Type at least 3 letters, or enter a 6 digit postal code";
            showSuggestions = false;
            searchResults.Clear();
            return;
        }

        try
        {
            isSuggesting = true;
            showSuggestions = true;

            var results = await OneMap.SearchAsync(qRaw);

            searchResults = results
                .Where(r => !string.IsNullOrWhiteSpace(r.ADDRESS))
                .Take(8)
                .ToList();

            if (searchResults.Count == 0)
            {
                searchError = "No results found";
                showSuggestions = false;
            }
        }
        catch
        {
            searchError = "Unable to contact OneMap right now. Please try again";
            showSuggestions = false;
            searchResults.Clear();
        }
        finally
        {
            isSuggesting = false;
            StateHasChanged();
        }
    }

    private static bool ShouldTriggerSuggestions(string q)
    {
        if (string.IsNullOrWhiteSpace(q)) return false;

        q = q.Trim();
        var digitsOnly = q.All(char.IsDigit);

        if (digitsOnly) return q.Length == 6;
        return q.Length >= 3;
    }

    private void SelectVenue(OneMapService.OneMapResult r)
    {
        if (eventModel == null) return;

        eventModel.VenueName = DisplayBuilding(r);
        eventModel.VenueAddress = r.ADDRESS ?? "";
        eventModel.PostalCode = r.POSTAL ?? "";

        venueSearch = eventModel.VenueName ?? "";

        showSuggestions = false;
        searchResults.Clear();
    }

    private static string DisplayBuilding(OneMapService.OneMapResult r)
    {
        if (!string.IsNullOrWhiteSpace(r.BUILDING)) return r.BUILDING!;
        if (!string.IsNullOrWhiteSpace(r.ROAD_NAME)) return r.ROAD_NAME!;
        if (!string.IsNullOrWhiteSpace(r.ADDRESS)) return r.ADDRESS!;
        return "Selected venue";
    }

    private async Task ResetTodayPlays()
    {
        await LocalStore.SetAsync($"mini_game_plays_used_{DateTime.Today:yyyyMMdd}", 0);
    }

}
