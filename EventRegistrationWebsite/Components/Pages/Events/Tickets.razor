@page "/events/tickets/{id:int}"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using EventRegistrationWebsite.Models
@using System.ComponentModel.DataAnnotations

@inject EventRegistrationWebsite.Data.ApplicationDbContext Db
@inject NavigationManager Nav

<h3 class="mb-3">Buy tickets</h3>

@if (ev == null)
{
    <div class="alert alert-warning">Event not found</div>
    <button class="btn btn-secondary" @onclick="Back">Back</button>
}
else
{
    <div class="row g-3">
        <div class="col-12 col-lg-7">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-1 fw-semibold">@ev.Title</h5>
                    <div class="text-muted">@($"{ev.StartDate:dd MMM yyyy} - {ev.EndDate:dd MMM yyyy}")</div>

                    @if (!string.IsNullOrWhiteSpace(ev.Description))
                    {
                        <div class="mt-3">
                            <div class="fw-semibold">About this event</div>
                            <div>@ev.Description</div>
                        </div>
                    }

                    <div class="mt-4">
                        <div class="fw-semibold">Ticketing</div>

                        @if (!ev.TicketingEnabled)
                        {
                            <div class="text-muted mt-1">Ticketing is turned off for this event</div>
                        }
                        else
                        {
                            <div class="mt-2 text-muted small">Ticket price (SGD)</div>
                            <div class="fw-bold fs-3">@PriceText</div>

                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center text-muted small">
                                    <span>Capacity</span>

                                    <div class="d-flex align-items-center gap-2">
                                        <span>@CapacityText</span>

                                        <span class="badge rounded-pill @(StatusLabel == "Full" ? "bg-danger" : StatusLabel == "Selling fast" ? "bg-warning text-dark" : "bg-success")">
                                            @StatusLabel
                                        </span>
                                    </div>
                                </div>

                                <div class="progress" style="height:10px;">
                                    <div class="progress-bar" role="progressbar" style="width:@($"{FillPct}%")"></div>
                                </div>

                                @if (ev.Capacity > 0)
                                {
                                    <div class="text-muted small mt-2">
                                        Seats left: @SeatsLeft
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <button class="btn btn-outline-secondary w-100 mt-3" @onclick="Back">
                Back to events
            </button>
        </div>

        <div class="col-12 col-lg-5">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">Checkout (mock)</h5>

                    @if (!ev.TicketingEnabled)
                    {
                        <div class="alert alert-info mb-0">
                            Ticketing is disabled, so checkout is hidden.
                        </div>
                    }
                    else
                    {
                        @if (!string.IsNullOrWhiteSpace(error))
                        {
                            <div class="alert alert-danger">@error</div>
                        }

                        @if (!string.IsNullOrWhiteSpace(message))
                        {
                            <div class="alert alert-success">@message</div>
                        }

                        <EditForm Model="@model" OnValidSubmit="Buy">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="mb-2">
                                <label class="form-label">Quantity</label>
                                <InputNumber class="form-control" @bind-Value="model.Quantity" />
                                <div class="form-text">
                                    Maximum tickets that can be purchased is @MaxPerOrder
                                </div>
                            </div>

                            <div class="p-3 rounded bg-light border mt-3">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Total (mock)</span>
                                    <span class="fw-semibold">@TotalText</span>
                                </div>

                                <button type="submit" class="btn btn-primary w-100 mt-3" disabled="@IsFull">
                                    Register (mock)
                                </button>

                                <div class="text-muted small mt-2">
                                    Registration and payment flow can be added later.
                                    This mock will increase occupancy.
                                </div>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }

    private Event? ev;
    private string message = "";
    private string error = "";
    private BuyModel model = new();

    protected override async Task OnInitializedAsync()
    {
        ev = await Db.Events.FirstOrDefaultAsync(x => x.EventID == id);
        model.Quantity = 1;
    }

    private void Back() => Nav.NavigateTo("/events");

    private int MaxPerOrder => 4;

    private decimal UnitPrice
    {
        get
        {
            if (ev == null) return 0;

            if (ev.TicketPriceMin <= 0 && ev.TicketPriceMax <= 0) return 0;

            if (ev.TicketPriceMin > 0 && ev.TicketPriceMax > 0 && ev.TicketPriceMin == ev.TicketPriceMax)
            {
                return ev.TicketPriceMin;
            }

            if (ev.TicketPriceMin > 0) return ev.TicketPriceMin;
            if (ev.TicketPriceMax > 0) return ev.TicketPriceMax;

            return 0;
        }
    }

    private string PriceText
    {
        get
        {
            if (ev == null) return "-";
            if (!ev.TicketingEnabled) return "Ticketing off";

            var min = ev.TicketPriceMin;
            var max = ev.TicketPriceMax;

            if (min <= 0 && max <= 0) return "Free";
            if (min > 0 && max > 0 && min == max) return $"SGD {min:0.00}";
            if (min > 0) return $"From SGD {min:0.00}";
            if (max > 0) return $"SGD {max:0.00}";
            return "Free";
        }
    }

    private int CapacityValue => ev?.Capacity ?? 0;

    private int RealSold
    {
        get
        {
            if (ev == null) return 0;
            var sold = ev.TicketsSold;
            if (sold < 0) sold = 0;

            if (CapacityValue > 0 && sold > CapacityValue)
            {
                sold = CapacityValue;
            }

            return sold;
        }
    }

    private int FillPct
    {
        get
        {
            if (ev == null) return 0;
            if (!ev.TicketingEnabled) return 0;

            if (ev.Capacity <= 0)
            {
                if (ev.DemoFillPercent.HasValue) return ClampPercent(ev.DemoFillPercent.Value);
                return 0;
            }

            if (ev.DemoFillPercent.HasValue) return ClampPercent(ev.DemoFillPercent.Value);

            var pct = (int)Math.Round((RealSold / (double)ev.Capacity) * 100.0);
            return ClampPercent(pct);
        }
    }

    private int SoldShown
    {
        get
        {
            if (ev == null) return 0;
            if (!ev.TicketingEnabled) return 0;
            if (ev.Capacity <= 0) return 0;

            var shown = (int)Math.Round(ev.Capacity * (FillPct / 100.0));
            if (shown < 0) shown = 0;
            if (shown > ev.Capacity) shown = ev.Capacity;
            return shown;
        }
    }

    private int SeatsLeft
    {
        get
        {
            if (CapacityValue <= 0) return int.MaxValue;
            return Math.Max(0, CapacityValue - SoldShown);
        }
    }

    private bool IsFull => CapacityValue > 0 && SoldShown >= CapacityValue;

    private string StatusLabel
    {
        get
        {
            if (!ev?.TicketingEnabled ?? true) return "";
            if (CapacityValue > 0 && FillPct >= 100) return "Full";
            if (FillPct >= 75) return "Selling fast";
            return "Available";
        }
    }

    private string CapacityText
    {
        get
        {
            if (ev == null) return "-";
            if (!ev.TicketingEnabled) return "-";

            if (ev.Capacity <= 0)
            {
                if (ev.DemoFillPercent.HasValue) return $"{FillPct}% shown";
                return "Unlimited";
            }

            return $"{SoldShown} / {ev.Capacity}";
        }
    }

    private string TotalText
    {
        get
        {
            var qty = model.Quantity;
            if (qty < 1) qty = 1;

            var total = UnitPrice * qty;
            return $"SGD {total:0.00}";
        }
    }

    private async Task Buy()
    {
        message = "";
        error = "";

        if (ev == null) return;
        if (!ev.TicketingEnabled) return;

        var qty = model.Quantity;

        if (qty < 1)
        {
            error = "Quantity must be at least 1";
            return;
        }

        if (qty > MaxPerOrder)
        {
            error = $"Maximum tickets that can be purchased is {MaxPerOrder}";
            return;
        }

        if (ev.Capacity > 0)
        {
            var remaining = ev.Capacity - SoldShown;
            if (remaining <= 0)
            {
                error = "No seats left (mock)";
                return;
            }

            if (qty > remaining)
            {
                error = $"Only {remaining} seat(s) left";
                return;
            }
        }

        ev.TicketsSold = RealSold + qty;
        ev.LastUpdatedOn = DateTime.Now;

        if (ev.Capacity > 0 && ev.DemoFillPercent.HasValue)
        {
            var addPct = (int)Math.Ceiling(qty / (double)ev.Capacity * 100.0);
            ev.DemoFillPercent = ClampPercent(ev.DemoFillPercent.Value + addPct);
        }

        await Db.SaveChangesAsync();

        model.Quantity = 1;
        message = $"Registered {qty} ticket(s) (mock). Occupancy increased.";
        StateHasChanged();
    }

    private static int ClampPercent(int p)
    {
        if (p < 0) return 0;
        if (p > 100) return 100;
        return p;
    }

    public class BuyModel
    {
        [Range(1, 1000)]
        public int Quantity { get; set; } = 1;
    }
}

