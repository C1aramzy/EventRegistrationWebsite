@page "/events/tickets/{id:int}"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using EventRegistrationWebsite.Models
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@inject EventRegistrationWebsite.Data.ApplicationDbContext Db
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<h3 class="mb-3">Buy tickets</h3>

@if (ev == null)
{
    <div class="alert alert-warning">Event not found</div>
    <button class="btn btn-secondary" @onclick="Back">Back</button>
}
else
{
    <div class="row g-3">
        <div class="col-12 col-lg-7">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-1 fw-semibold">@ev.Title</h5>
                    <div class="text-muted">@($"{ev.StartDate:dd MMM yyyy} - {ev.EndDate:dd MMM yyyy}")</div>

                    @if (!string.IsNullOrWhiteSpace(ev.Description))
                    {
                        <div class="mt-3">
                            <div class="fw-semibold">About this event</div>
                            <div>@ev.Description</div>
                        </div>
                    }

                    <div class="mt-4">
                        <div class="fw-semibold">Ticketing</div>

                        @if (!ev.TicketingEnabled)
                        {
                            <div class="text-muted mt-1">Ticketing is turned off for this event</div>
                        }
                        else
                        {
                            <div class="mt-2 text-muted small">Ticket price (SGD)</div>
                            <div class="fw-bold fs-3">@PriceText</div>

                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center text-muted small">
                                    <span>Capacity</span>

                                    <div class="d-flex align-items-center gap-2">
                                        <span>@CapacityText</span>

                                        <span class="badge rounded-pill @(StatusLabel == "Full" ? "bg-danger" : StatusLabel == "Selling fast" ? "bg-warning text-dark" : "bg-success")">
                                            @StatusLabel
                                        </span>
                                    </div>
                                </div>

                                <div class="progress" style="height:10px;">
                                    <div class="progress-bar" role="progressbar" style="width:@($"{FillPct}%")"></div>
                                </div>

                                @if (ev.Capacity > 0)
                                {
                                    <div class="text-muted small mt-2">
                                        Seats left: @SeatsLeft
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <button class="btn btn-outline-secondary w-100 mt-3" @onclick="Back" disabled="@isSubmitting">
                Back to events
            </button>
        </div>

        <div class="col-12 col-lg-5">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">Checkout</h5>

                    @if (!ev.TicketingEnabled)
                    {
                        <div class="alert alert-info mb-0">
                            Ticketing is disabled, so checkout is hidden.
                        </div>
                    }
                    else
                    {
                        @if (!string.IsNullOrWhiteSpace(error))
                        {
                            <div class="alert alert-danger">@error</div>
                        }

                        @if (!string.IsNullOrWhiteSpace(message))
                        {
                            <div class="alert alert-success">@message</div>
                        }

                        <EditForm Model="@model" OnValidSubmit="Buy">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="mb-2">
                                <label class="form-label">Quantity</label>
                                <InputNumber class="form-control" @bind-Value="model.Quantity" disabled="@isSubmitting" />
                                <div class="form-text">
                                    Maximum tickets that can be purchased is @MaxPerOrder
                                </div>
                            </div>

                            <div class="p-3 rounded bg-light border mt-3">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Total</span>
                                    <span class="fw-semibold">@TotalText</span>
                                </div>

                                <button type="submit" class="btn btn-primary w-100 mt-3" disabled="@(!CanSubmit)">
                                    @(isSubmitting ? "Redirecting..." : "Proceed to payment")
                                </button>

                                <div class="text-muted small mt-2">
                                    You will be redirected to a secure payment page to complete checkout.
                                </div>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }

    private Event? ev;
    private string message = "";
    private string error = "";
    private BuyModel model = new();

    private bool isSubmitting;

    private bool CanSubmit => ev != null && ev.TicketingEnabled && !IsFull && !isSubmitting;

    protected override async Task OnInitializedAsync()
    {
        ev = await Db.Events.FirstOrDefaultAsync(x => x.EventID == id);
        model.Quantity = 1;
    }

    private void Back() => Nav.NavigateTo("/events");

    private int MaxPerOrder
    {
        get
        {
            if (ev == null) return 4;
            if (ev.MaxTicketsPerOrder <= 0) return 4;
            return ev.MaxTicketsPerOrder;
        }
    }

    private decimal UnitPrice
    {
        get
        {
            if (ev == null) return 0;

            if (ev.TicketPriceMin <= 0 && ev.TicketPriceMax <= 0) return 0;

            if (ev.TicketPriceMin > 0 && ev.TicketPriceMax > 0 && ev.TicketPriceMin == ev.TicketPriceMax)
            {
                return ev.TicketPriceMin;
            }

            if (ev.TicketPriceMin > 0) return ev.TicketPriceMin;
            if (ev.TicketPriceMax > 0) return ev.TicketPriceMax;

            return 0;
        }
    }

    private string PriceText
    {
        get
        {
            if (ev == null) return "-";
            if (!ev.TicketingEnabled) return "Ticketing off";

            var min = ev.TicketPriceMin;
            var max = ev.TicketPriceMax;

            if (min <= 0 && max <= 0) return "Free";
            if (min > 0 && max > 0 && min == max) return $"SGD {min:0.00}";
            if (min > 0) return $"From SGD {min:0.00}";
            if (max > 0) return $"SGD {max:0.00}";
            return "Free";
        }
    }

    private int CapacityValue => ev?.Capacity ?? 0;

    private int RealSold
    {
        get
        {
            if (ev == null) return 0;
            var sold = ev.TicketsSold;
            if (sold < 0) sold = 0;

            if (CapacityValue > 0 && sold > CapacityValue)
            {
                sold = CapacityValue;
            }

            return sold;
        }
    }

    private int FillPct
    {
        get
        {
            if (ev == null) return 0;
            if (!ev.TicketingEnabled) return 0;
            if (ev.Capacity <= 0) return 0;

            var pct = (int)Math.Round((RealSold / (double)ev.Capacity) * 100.0);
            return ClampPercent(pct);
        }
    }

    private int SeatsLeft
    {
        get
        {
            if (CapacityValue <= 0) return int.MaxValue;
            return Math.Max(0, CapacityValue - RealSold);
        }
    }

    private bool IsFull => CapacityValue > 0 && RealSold >= CapacityValue;

    private string StatusLabel
    {
        get
        {
            if (!ev?.TicketingEnabled ?? true) return "";
            if (CapacityValue > 0 && FillPct >= 100) return "Full";
            if (FillPct >= 75) return "Selling fast";
            return "Available";
        }
    }

    private string CapacityText
    {
        get
        {
            if (ev == null) return "-";
            if (!ev.TicketingEnabled) return "-";
            if (ev.Capacity <= 0) return "Unlimited";
            return $"{RealSold} / {ev.Capacity}";
        }
    }

    private string TotalText
    {
        get
        {
            var qty = model.Quantity;
            if (qty < 1) qty = 1;

            var total = UnitPrice * qty;
            return $"SGD {total:0.00}";
        }
    }

    private async Task Buy()
    {
        if (isSubmitting) return;

        isSubmitting = true;
        message = "";
        error = "";

        try
        {
            if (ev == null) return;
            if (!ev.TicketingEnabled) return;

            var qty = model.Quantity;

            if (qty < 1)
            {
                error = "Quantity must be at least 1";
                return;
            }

            if (qty > MaxPerOrder)
            {
                error = $"Maximum tickets that can be purchased is {MaxPerOrder}";
                return;
            }

            if (ev.Capacity > 0)
            {
                var remaining = ev.Capacity - RealSold;

                if (remaining <= 0)
                {
                    error = "No seats left";
                    return;
                }

                if (qty > remaining)
                {
                    error = $"Only {remaining} seat(s) left";
                    return;
                }
            }

            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = auth.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (string.IsNullOrWhiteSpace(userId))
            {
                error = "You must be logged in to continue.";
                return;
            }

            var existingPendingPayment = await Db.PaymentTransactions
                .Where(p => p.UserId == userId && p.Status == "Pending")
                .Join(
                    Db.OrderDrafts.Where(d =>
                        d.UserId == userId &&
                        d.EventID == ev.EventID &&
                        d.TicketQuantity == qty &&
                        d.Status == "Pending"),
                    p => p.OrderDraftId,
                    d => d.OrderDraftId,
                    (p, d) => p)
                .OrderByDescending(p => p.CreatedOn)
                .FirstOrDefaultAsync();

            if (existingPendingPayment != null)
            {
                Nav.NavigateTo($"/pay/gateway/{existingPendingPayment.PaymentTransactionId}");
                return;
            }

            var subtotal = UnitPrice * qty;

            var draft = new OrderDraft
            {
                UserId = userId,
                EventID = ev.EventID,
                TicketQuantity = qty,
                Subtotal = subtotal,
                Discount = 0,
                FinalAmount = subtotal,
                Status = "Pending"
            };

            Db.OrderDrafts.Add(draft);
            await Db.SaveChangesAsync();

            var payment = new PaymentTransaction
            {
                OrderDraftId = draft.OrderDraftId,
                UserId = userId,
                Amount = draft.FinalAmount,
                Status = "Pending"
            };

            Db.PaymentTransactions.Add(payment);
            await Db.SaveChangesAsync();

            Nav.NavigateTo($"/pay/gateway/{payment.PaymentTransactionId}");
        }
        finally
        {
            if (!string.IsNullOrWhiteSpace(error))
            {
                isSubmitting = false;
            }
        }
    }

    private static int ClampPercent(int p)
    {
        if (p < 0) return 0;
        if (p > 100) return 100;
        return p;
    }

    public class BuyModel
    {
        [Range(1, 1000)]
        public int Quantity { get; set; } = 1;
    }
}
