@page "/packages"
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using EventRegistrationWebsite.Models

@inject EventRegistrationWebsite.Data.ApplicationDbContext Db
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<style>
    :root {
        --bg: #fff5f8;
        --card: #ffffff;
        --border: rgba(236,72,153,.18);
        --soft: rgba(236,72,153,.08);
        --accent: #ec4899;
        --accent2: #db2777;
        --text: rgba(0,0,0,.86);
        --muted: rgba(0,0,0,.56);
        --shadow: 0 12px 30px rgba(236,72,153,.12);
        --radius: 20px;
    }

    .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 22px 18px 34px 18px;
    }

    .title {
        font-size: 44px;
        font-weight: 900;
        margin: 0;
        letter-spacing: .2px;
        color: var(--text);
    }

    .sub {
        margin-top: 6px;
        max-width: 820px;
        font-size: 14px;
        color: var(--muted);
    }

    .pillRow {
        margin-top: 14px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .pill {
        border-radius: 999px;
        padding: 6px 12px;
        border: 1px solid var(--border);
        background: var(--soft);
        color: var(--accent2);
        font-weight: 650;
        font-size: 12px;
    }

    .cardPink {
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: linear-gradient(180deg,#fff,var(--bg));
        box-shadow: var(--shadow);
    }

    .cardPad {
        padding: 16px;
    }

    .btnPink {
        background: var(--accent);
        border: 1px solid var(--accent);
        color: #fff;
        border-radius: 14px;
        padding: 10px 14px;
        font-weight: 750;
    }

        .btnPink:hover {
            background: var(--accent2);
            border-color: var(--accent2);
        }

    .btnPinkOutline {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--accent2);
        border-radius: 14px;
        padding: 10px 14px;
        font-weight: 750;
    }

        .btnPinkOutline:hover {
            background: var(--soft);
        }

    .softInput {
        border-radius: 14px;
        border: 1px solid rgba(236,72,153,.22);
    }

        .softInput:focus {
            box-shadow: 0 0 0 .2rem rgba(236,72,153,.18);
            border-color: rgba(236,72,153,.45);
        }

    .gridCards {
        margin-top: 14px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
    }

    .pkgCard {
        border-radius: 20px;
        border: 1px solid var(--border);
        background: linear-gradient(180deg,#fff,var(--bg));
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .pkgBody {
        padding: 16px;
        display: grid;
        grid-template-columns: minmax(0,1fr) 260px;
        gap: 14px;
        align-items: start;
    }

    .pkgName {
        margin: 0;
        font-weight: 900;
        color: var(--text);
        font-size: 18px;
    }

    .pkgDesc {
        margin-top: 6px;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.35rem;
        white-space: pre-line;
    }

    .tagRow {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        padding: 6px 10px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,.7);
        color: var(--text);
        font-weight: 650;
        font-size: 12px;
    }

    .tagStrong {
        border-color: rgba(16,185,129,.25);
        background: rgba(16,185,129,.10);
        color: rgba(5,120,87,1);
    }

    .tagDanger {
        border-color: rgba(239,68,68,.28);
        background: rgba(239,68,68,.10);
        color: rgba(153,27,27,1);
    }

    .rightBox {
        text-align: right;
    }

    .price {
        font-size: 26px;
        font-weight: 950;
        color: var(--text);
        letter-spacing: .2px;
    }

    .strike {
        text-decoration: line-through;
        color: rgba(0,0,0,.45);
        font-size: 13px;
        margin-top: 4px;
        font-weight: 700;
    }

    .rightMeta {
        color: var(--muted);
        font-size: 12px;
        margin-top: 8px;
        line-height: 1.15rem;
    }

    .rightBtns {
        margin-top: 10px;
        display: grid;
        gap: 10px;
    }

    @@media (max-width: 980px) {
        .pkgBody {
            grid-template-columns: 1fr;
            text-align: left;
        }

        .rightBox {
            text-align: left;
        }
    }

    @@media (max-width: 640px) {
        .title {
            font-size: 34px;
        }
    }
</style>

<div class="wrap">
    <h1 class="title">Packages</h1>
    <div class="sub">
        Klook style bundle deals that include multiple events and optional items.
    </div>

    <div class="pillRow">
        @if (IsAdmin)
        {
            <span class="pill">Admin only</span>
        }
        <span class="pill">Packages</span>
        <span class="pill">Bundles</span>
    </div>

    <div class="cardPink mt-3">
        <div class="cardPad">
            <div class="row g-2 align-items-center">
                <div class="col-12 col-md-6">
                    <input class="form-control softInput"
                           placeholder="Search package name"
                           @bind="searchText"
                           @bind:event="oninput" />
                </div>

                <div class="col-12 col-md-3">
                    <select class="form-select softInput" @bind="statusFilter">
                        <option value="">All</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>

                <div class="col-12 col-md-3 d-flex gap-2 flex-wrap justify-content-md-end">
                    <button class="btnPinkOutline" @onclick="ClearFilters">
                        Clear
                    </button>

                    @if (IsAdmin)
                    {
                        <button class="btnPink" @onclick="GoCreate">
                            + Create package
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        @if (isLoading)
        {
            <div class="cardPink">
                <div class="cardPad">
                    <div class="text-muted">Loading packages...</div>
                </div>
            </div>
        }
        else if (!FilteredPackages.Any())
        {
            <div class="cardPink">
                <div class="cardPad">
                    <div class="alert alert-info mb-0">No packages found.</div>
                </div>
            </div>
        }
        else
        {
            <div class="gridCards">
                @foreach (var p in FilteredPackages)
                {
                    var eventsCount = p.PackageEvents?.Count ?? 0;

                    <div class="pkgCard">
                        <div class="pkgBody">
                            <div>
                                <h3 class="pkgName">@p.PackageName</h3>

                                @if (!string.IsNullOrWhiteSpace(p.Description))
                                {
                                    <div class="pkgDesc">@p.Description</div>
                                }

                                <div class="tagRow">
                                    <span class="tag @(p.IsActive ? "tagStrong" : "tagDanger")">
                                        @(p.IsActive ? "Active" : "Inactive")
                                    </span>

                                    @if (p.BundleEventID.HasValue)
                                    {
                                        <span class="tag">Bundle event</span>
                                    }

                                    <span class="tag">
                                        Events: @eventsCount
                                    </span>

                                    @if (p.MaxPerUser > 0)
                                    {
                                        <span class="tag">Max per user: @p.MaxPerUser</span>
                                    }

                                    @if (p.OriginalTotalPrice.HasValue && p.OriginalTotalPrice.Value > p.Price)
                                    {
                                        var save = p.OriginalTotalPrice.Value - p.Price;
                                        <span class="tag tagStrong">Save SGD @save.ToString("0.00")</span>
                                    }
                                </div>
                            </div>

                            <div class="rightBox">
                                <div class="price">SGD @p.Price.ToString("0.00")</div>

                                @if (p.OriginalTotalPrice.HasValue && p.OriginalTotalPrice.Value > p.Price)
                                {
                                    <div class="strike">SGD @p.OriginalTotalPrice.Value.ToString("0.00")</div>
                                }

                                <div class="rightMeta">
                                    <div>Updated: @p.LastUpdatedOn.ToString("dd/MM/yyyy HH:mm")</div>
                                </div>

                                <div class="rightBtns">
                                    @if (IsAdmin)
                                    {
                                        <button class="btnPinkOutline" @onclick="() => GoEdit(p.PackageID)">
                                            Edit
                                        </button>

                                        <button class="btn btn-outline-danger" @onclick="() => GoDelete(p.PackageID)">
                                            Delete
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btnPinkOutline" @onclick="() => GoBrowse(p.PackageID)">
                                            View package
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private bool isLoading = true;
    private bool IsAdmin;

    private List<Package> packages = new();

    private string searchText = "";
    private string statusFilter = "";

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        IsAdmin = auth.User.IsInRole("Admin");

        packages = await Db.Packages
            .Include(p => p.BundleEvent)
            .Include(p => p.PackageEvents)
                .ThenInclude(pe => pe.Event)
            .OrderByDescending(p => p.IsActive)
            .ThenByDescending(p => p.LastUpdatedOn)
            .ToListAsync();

        isLoading = false;
    }

    private IEnumerable<Package> FilteredPackages =>
        packages
            .Where(p =>
                (string.IsNullOrWhiteSpace(searchText) ||
                 (p.PackageName?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                 (p.Description?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false))
                && (string.IsNullOrWhiteSpace(statusFilter) ||
                    (statusFilter == "Active" && p.IsActive) ||
                    (statusFilter == "Inactive" && !p.IsActive)));

    private void ClearFilters()
    {
        searchText = "";
        statusFilter = "";
    }

    private void GoCreate() => Nav.NavigateTo("/packages/create");
    private void GoEdit(int id) => Nav.NavigateTo($"/packages/edit/{id}");
    private void GoDelete(int id) => Nav.NavigateTo($"/packages/delete/{id}");

    private void GoBrowse(int id) => Nav.NavigateTo($"/packages/details/{id}");
}
